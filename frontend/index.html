<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemo Compliance MVP - 中国能源项目法规查询</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%23667eea'/%3E%3Ctext x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3EN%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 10px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-bar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .status-dot.healthy {
            background-color: #4CAF50;
        }

        .status-dot.error {
            background-color: #f44336;
        }

        .query-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .province-select, .question-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .province-select:focus, .question-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .asset-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .asset-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .asset-btn:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .asset-btn.active {
            border-color: #667eea;
            background-color: #667eea;
            color: white;
        }

        .language-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .lang-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lang-btn.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }

        .results h2 {
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .answer-content {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 2rem;
            white-space: pre-line;
        }

        .citations {
            border-top: 1px solid #eee;
            padding-top: 1.5rem;
        }

        .citations h3 {
            margin-bottom: 1rem;
            color: #555;
        }

        .citation-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .citation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .citation-date {
            color: #666;
            font-size: 14px;
            margin-bottom: 0.5rem;
        }

        .citation-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .citation-link:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #f44336;
            margin-bottom: 1rem;
        }

        .refusal-message {
            background: #fff3e0;
            color: #ef6c00;
            padding: 1.5rem;
            border-radius: 6px;
            border-left: 4px solid #ff9800;
        }

        .refusal-tips {
            margin-top: 1rem;
        }

        .refusal-tips ul {
            margin-left: 1.5rem;
        }

        .trace-id {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-top: 1rem;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .asset-buttons {
                flex-direction: column;
            }

            .asset-btn {
                min-width: auto;
            }

            .status-bar {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="headerTitle">Nemo Compliance MVP</h1>
            <p id="headerSubtitle">中国能源项目法规查询系统</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">检查系统状态中...</span>
            </div>
            <div class="language-toggle">
                <button class="lang-btn active" data-lang="zh-CN">中文</button>
                <button class="lang-btn" data-lang="en">English</button>
            </div>
        </div>

        <form class="query-form" id="queryForm">
            <div class="form-group">
                <label for="province" id="labelProvince">选择省份 / Select Province:</label>
                <select class="province-select" id="province" required>
                    <option value="">请选择省份...</option>
                    <option value="gd">广东省 (Guangdong)</option>
                    <option value="sd">山东省 (Shandong)</option>
                    <option value="nm">内蒙古自治区 (Inner Mongolia)</option>
                </select>
            </div>

            <div class="form-group">
                <label id="labelAsset">选择资产类型 / Select Asset Type:</label>
                <div class="asset-buttons">
                    <button type="button" class="asset-btn" data-asset="solar" id="btnSolar">光伏 Solar</button>
                    <button type="button" class="asset-btn" data-asset="coal" id="btnCoal">煤电 Coal</button>
                    <button type="button" class="asset-btn" data-asset="wind" id="btnWind">风电 Wind</button>
                </div>
            </div>

            <div class="form-group">
                <label for="question" id="labelQuestion">您的问题 / Your Question:</label>
                <textarea 
                    class="question-input" 
                    id="question" 
                    rows="3" 
                    placeholder="例如：并网验收需要哪些资料？"
                    required
                ></textarea>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                查询法规信息 / Query Regulations
            </button>
        </form>

            <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">正在查询相关法规文件...</p>
        </div>

        <div class="results" id="results">
            <h2 id="resultsTitle">查询结果</h2>
            <div class="answer-content" id="answerContent"></div>
            <div class="citations" id="citations">
                <h3>参考文献 / References</h3>
                <div id="citationsList"></div>
            </div>
            <div class="trace-id" id="traceId"></div>
        </div>
    </div>

    <script>
        // Configuration
        const PROJECT_ID = 'day-planner-london-mvp';
        const REGION = 'asia-east2';
        const OVERRIDE = window.NEMO_API || {};
        const API_BASE = OVERRIDE.QUERY_URL || (window.location.hostname === 'localhost'
            ? 'http://localhost:8081'
            : '/api/query');
        const HEALTH_URL = OVERRIDE.HEALTH_URL || (window.location.hostname === 'localhost'
            ? 'http://localhost:8080'
            : '/api/health');

        // State
        let selectedAsset = '';
        let selectedLanguage = 'zh-CN';

        // DOM Elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const queryForm = document.getElementById('queryForm');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const submitBtn = document.getElementById('submitBtn');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            applyLanguage(selectedLanguage);
            checkSystemHealth();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Asset selection
            document.querySelectorAll('.asset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.asset-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedAsset = this.dataset.asset;
                });
            });

            // Language toggle
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedLanguage = this.dataset.lang;
                    applyLanguage(selectedLanguage);
                });
            });

            // Form submission
            queryForm.addEventListener('submit', handleSubmit);

            // Enter key support
            document.getElementById('question').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    handleSubmit(e);
                }
            });
        }

        async function checkSystemHealth() {
            try {
                const response = await fetch(HEALTH_URL);
                const data = await response.json();

                if (data.status === 'ok') {
                    statusDot.className = 'status-dot healthy';
                    statusText.textContent = selectedLanguage.startsWith('zh') ? '系统正常' : 'System Healthy';
                } else {
                    statusDot.className = 'status-dot error';
                    statusText.textContent = selectedLanguage.startsWith('zh') ? '系统异常' : 'System Degraded';
                }
            } catch (error) {
                statusDot.className = 'status-dot error';
                statusText.textContent = selectedLanguage.startsWith('zh') ? '无法连接系统' : 'Cannot Connect';
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const province = document.getElementById('province').value;
            const question = document.getElementById('question').value;

            if (!province || !selectedAsset || !question.trim()) {
                alert('请填写所有必填字段 / Please fill all required fields');
                return;
            }

            // Show loading
            queryForm.style.display = 'none';
            results.style.display = 'none';
            loading.style.display = 'block';

            try {
                const requestData = {
                    province: province,
                    asset: selectedAsset,
                    doc_class: 'grid',
                    question: question.trim(),
                    lang: selectedLanguage
                };

                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    displayError(data);
                }
            } catch (error) {
                displayError({
                    error: true,
                    message: '网络连接错误 / Network Error: ' + error.message,
                    trace_id: 'client-error-' + Date.now()
                });
            } finally {
                loading.style.display = 'none';
                queryForm.style.display = 'block';
            }
        }

        function displayResults(data) {
            const resultsTitle = document.getElementById('resultsTitle');
            const answerContent = document.getElementById('answerContent');
            const citations = document.getElementById('citations');
            const citationsList = document.getElementById('citationsList');
            const traceId = document.getElementById('traceId');
            resultsTitle.textContent = selectedLanguage.startsWith('zh') ? '查询结果' : 'Results';
            if (data.refusal) {
                // Display refusal message
                answerContent.innerHTML = `
                    <div class="refusal-message">
                        <strong>${data.refusal}</strong>
                        ${data.tips ? `
                            <div class="refusal-tips">
                                <p>${selectedLanguage.startsWith('zh') ? '建议' : 'Suggestions'}:</p>
                                <ul>
                                    ${data.tips.map(tip => `<li>${tip}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                citations.style.display = 'none';
            } else if (data.answer_zh) {
                // Display answer with citations
                answerContent.textContent = data.answer_zh || data.answer;

                if (data.citations && data.citations.length > 0) {
                    citationsList.innerHTML = data.citations.map(citation => `
                        <div class="citation-item">
                            <div class="citation-title">${citation.title}</div>
                            ${citation.effective_date ? `
                                <div class="citation-date">${selectedLanguage.startsWith('zh') ? '生效日期' : 'Effective Date'}: ${citation.effective_date}</div>
                            ` : ''}
                            <a href="${citation.url}" target="_blank" class="citation-link">
                                ${selectedLanguage.startsWith('zh') ? '查看原文' : 'View Source'} →
                            </a>
                        </div>
                    `).join('');
                    citations.style.display = 'block';
                } else {
                    citations.style.display = 'none';
                }
            }

            traceId.textContent = `${selectedLanguage.startsWith('zh') ? 'Trace ID' : 'Trace ID'}: ${data.trace_id || 'unknown'}`;
            results.style.display = 'block';
        }

        function displayError(data) {
            const answerContent = document.getElementById('answerContent');
            const citations = document.getElementById('citations');
            const traceId = document.getElementById('traceId');

            answerContent.innerHTML = `
                <div class="error-message">
                    <strong>${selectedLanguage.startsWith('zh') ? '查询出错' : 'Query Error'}</strong><br>
                    ${data.message || (selectedLanguage.startsWith('zh') ? '未知错误' : 'Unknown Error')}
                </div>
            `;

            citations.style.display = 'none';
            traceId.textContent = `${selectedLanguage.startsWith('zh') ? 'Trace ID' : 'Trace ID'}: ${data.trace_id || 'unknown'}`;
            results.style.display = 'block';
        }

        function applyLanguage(lang) {
            const zh = (lang || '').startsWith('zh');
            // Header
            document.getElementById('headerTitle').textContent = zh ? 'Nemo 合规 MVP' : 'Nemo Compliance MVP';
            document.getElementById('headerSubtitle').textContent = zh ? '中国能源项目法规查询系统' : 'China Energy Project Regulations Assistant';
            // Labels
            document.getElementById('labelProvince').textContent = zh ? '选择省份' : 'Select Province';
            document.getElementById('labelAsset').textContent = zh ? '选择资产类型' : 'Select Asset Type';
            document.getElementById('labelQuestion').textContent = zh ? '您的问题' : 'Your Question';
            // Asset buttons
            document.getElementById('btnSolar').textContent = zh ? '光伏' : 'Solar';
            document.getElementById('btnCoal').textContent = zh ? '煤电' : 'Coal';
            document.getElementById('btnWind').textContent = zh ? '风电' : 'Wind';
            // Submit button
            document.getElementById('submitBtn').textContent = zh ? '查询法规信息' : 'Query Regulations';
            // Loading
            document.getElementById('loadingText').textContent = zh ? '正在查询相关法规文件...' : 'Fetching relevant regulatory documents...';
            // Placeholders
            const questionInput = document.getElementById('question');
            if (questionInput) questionInput.placeholder = zh ? '请输入问题（例如：并网验收资料清单）' : 'Type your question (e.g., grid acceptance checklist)';
            const provSelect = document.getElementById('province');
            if (provSelect) {
                provSelect.options[0].textContent = zh ? '请选择省份...' : 'Please select a province...';
                provSelect.options[1].textContent = zh ? '广东省 (Guangdong)' : 'Guangdong (gd)';
                provSelect.options[2].textContent = zh ? '山东省 (Shandong)' : 'Shandong (sd)';
                provSelect.options[3].textContent = zh ? '内蒙古自治区 (Inner Mongolia)' : 'Inner Mongolia (nm)';
            }
        }
    </script>
</body>
</html>
